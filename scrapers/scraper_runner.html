<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chabad Scraper Runner</title>
</head>
<body>
    <h1>Chabad Book Scraper</h1>
    <p>Open browser console (F12) to see progress.</p>
    <div id="status">Loading book data...</div>
    <div id="results"></div>
    <button onclick="downloadAll()">Download All as ZIP</button>

    <script>
        //B"H
        var allData = {};

        async function getSeferHamaamarimMelukat(startIndex = 0) {
            var nav = await fetch(
                "https://www.chabad.org/api/v2/chabadorg/torahtexts/book-navigation/3139962"
            )
            var j = await nav.json();

            var sections = j.children;
            console.log("Got sections!", sections)
            updateStatus("Found " + sections.length + " sections");

            var t;
            for(t = startIndex; t < sections.length; t++) {
                var section = sections[t];
                if(!section) continue;
                
                var sectionName = section["native-title"] || "Section " + t;
                allData[sectionName] = {};
                updateStatus("Processing section: " + sectionName);
                
                var subsections = section.children;
                console.log("Subsections", subsections)
                var i;
                for(i = 0; i < subsections.length; i++) {
                    var subsection = subsections[i];
                    var subsectionName = subsection["native-title"] || "Subsection " + i;
                    allData[sectionName][subsectionName] = {};
                    
                    var pages = subsection.children;
                    var c;
                    console.log("pages", pages)
                    for(c = 0; c < pages.length; c++) {
                        var pg = pages[c];
                        if(!pg) {
                            console.log("no page!", pg);
                            continue;
                        }
                        console.log("page", pages[c])
                        var article = pg["article-id"];
                        var urlBase = "https://www.chabad.org/api/v2/chabadorg/torahtexts/book-content/"

                        var articleURL = urlBase + article;
                        var pageName = pg["native-title-2"];

                        updateStatus("Downloading: " + pageName);
                        
                        var art = await fetch(articleURL);
                        var js = await art.json();

                        var v = js.verses;    
                        
                        console.log("verses", v)
                        allData[sectionName][subsectionName][pageName] = v;
                        
                        // Small delay to avoid overwhelming the server
                        await new Promise(resolve => setTimeout(resolve, 200));
                    }   
                }
            }
            
            displayResults();
            updateStatus("Scraping completed! Data loaded.");
        }

        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }

        function displayResults() {
            var resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<h2>Book Structure:</h2>';
            
            for(var section in allData) {
                resultsDiv.innerHTML += '<h3>' + section + '</h3>';
                for(var subsection in allData[section]) {
                    resultsDiv.innerHTML += '<h4>' + subsection + '</h4>';
                    resultsDiv.innerHTML += '<ul>';
                    for(var page in allData[section][subsection]) {
                        var verseCount = allData[section][subsection][page].length;
                        resultsDiv.innerHTML += '<li>' + page + ' (' + verseCount + ' verses)</li>';
                    }
                    resultsDiv.innerHTML += '</ul>';
                }
            }
        }

        function downloadAll() {
            var blob = new Blob([JSON.stringify(allData, null, 2)], {type: 'application/json'});
            var url = URL.createObjectURL(blob);
            
            var a = document.createElement('a');
            a.href = url;
            a.download = 'Sefer_Hamaamarim_Melukat_Complete.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            URL.revokeObjectURL(url);
        }

        // Auto-run on page load
        window.onload = function() {
            getSeferHamaamarimMelukat(0);
        };
    </script>
</body>
</html>
