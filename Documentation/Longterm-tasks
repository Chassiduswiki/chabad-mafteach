# Chabad Mafteach Frontend Roadmap

## Current Status
- âœ… Topics pages simplified to use minimal Directus fields (canonical_title, topic_type, description).
- âœ… **TypeScript schema aligned with new Directus data model** (Dec 8, 2025).
- âœ… Tanya reader now fetches from Directus (paragraphs/statements) instead of hardcoded data.
- âœ… Search API stabilized with error handling for permissions.
- âœ… Mobile search modal layout improved.
- âœ… Legacy type aliases added for backward compatibility (Seferâ†’Document, Locationâ†’Paragraph, etc.).
- âœ… **Premium BookReader component created** - transforms seforim page into professional reading experience (Dec 8, 2025).
- âœ… **Seforim UX issues resolved** - fixed z-index, mobile popup, click-to-close functionality (Dec 8, 2025).
- âœ… **Track 2c: Mobile Search UX Upgrade** - Premium bottom-sheet with swipe gestures & native feel (Dec 24, 2025).
- âœ… **Track 2b: Seforim Search Implementation** - Bilingual discovery (Tanya â†’ ×œ×™×§×•×˜×™ ××ž×¨×™×) & expanded collection search.
- âœ… **Premium 404 & Explore Pages** - High-end mobile-first redesigns with glassmorphism (Dec 2025).
- âœ… **Seforim page accessibility fixed** - Resolved TypeError in Directus client initialization (Dec 25, 2025).
- âœ… **Search modal issues resolved** - Fixed navigation to undefined IDs and added mobile Cancel button (Dec 25, 2025).
- âœ… **Track 1, Phase 1d: Citations & Sources** - Statement-first research UI with book grouping (Dec 25, 2025).
- âœ… **Track 11: Explore & Discovery Upgrade** - Passive discovery (Zen) and intentional hubs (Topics) (Dec 25, 2025).
- â³ **Next: Prioritize TRACK 12 (Data Ingestion Engine) or Phase 11b curation filters.**


## Schema Migration Notes (Dec 8, 2025)
The frontend TypeScript types now match the new Directus schema:
- **Collections**: `documents`, `paragraphs`, `statements`, `topics`, `statement_topics`, `sources`, `source_links`, `translations`
- **Removed**: `seforim`, `locations`, `texts`, `topic_citations` (replaced with new collections)
- **See**: `Documentation/New-directus-data-model.md` for complete schema reference

---

## TRACK 1: Topics Detail Page (Unblock everything else)

**Goal**: Make `/topics/[slug]` simple, fast, and honest about what data exists.

### Phase 1a: MVP Detail Page (IMMEDIATE)
- [x] Simplify `TopicHeader` to show only: title (canonical_title), category (topic_type), short description.
- [x] Remove or feature-flag `BoundariesTab`, `SourcesTab`, `RelatedTab` from `TopicTabs` (mark as "Coming soon").
- [x] Remove `TopicSidebar` from detail page layout.
- [x] Test: `/topics/[slug]` loads fast, renders cleanly on desktop + mobile, never shows broken/empty sections.

### Phase 1b: Rich Content Fields (COMPLETED - Dec 25, 2025)
- [x] Added `overview`, `article`, `practical_takeaways`, `historical_context` fields to `Topic` type.
- [x] Created `OverviewTab` to render rich content summary before the detailed source blocks.
- [x] Updated `TopicTabs` dynamic visibility logic (hide empty tabs, show "Coming Soon" or valid content).

### Phase 1c: Boundaries & Relationships (COMPLETED - Dec 25, 2025)
- [x] Wired `BoundariesTab` to render `definition_positive` and `definition_negative`.
- [x] Implemented `RelatedTab` with actual `topic_relationships` data.
- [x] Fixed duplicated cases and missing props in `TopicTabs.tsx`.

### Phase 1d: Citations & Sources (COMPLETED - Dec 25, 2025)
- [x] Redesign `SourcesTab` to query `statements` tagged with topic (via `statement_topics`), grouped by book.
- [x] Implement "Statement-First" premium UI for topic exploration.
- [x] Added "Copy Citation" and "View in context" deep linking.
> [!NOTE]
> Functional unblocking requires Directus permission update for `statement_topics` collection fields (`statement_id`, `topic_id`).

---

## TRACK 11: Explore & Discovery Upgrade (NEW)
**Goal**: Transform Explore from a redundant browse page into a "passive discovery" experience and centralize intentional browsing in Topics.

### Phase 11a: Topics Page Consolidation (COMPLETED - Dec 24, 2025)
- [x] Extract `TopicCategoryChips` for horizontal category scrolling.
- [x] Implement `FeaturedTopicCard` for editorial highlights.
- [x] Merge Explore category browsing into `/topics` header area for cleaner navigation.

### Phase 11b: Zen Explore Experience (COMPLETED - Dec 25, 2025)
- [x] Rebuild `/explore` as a full-screen, mobile-first "one quote at a time" interface.
- [x] Implement random statement API for serendipitous discovery.
- [x] Add "Go to Source" and "Share" actions to the Zen cards.
- [ ] **Curated Discovery:** Add `is_for_you` or `explore_eligible` checkbox to `statements` collection for editorial control.
- [ ] Add swipe/pull gestures for "Next Quote" interaction.

---

## TRACK 2: Search (Topics-first, then Seforim)

**Goal**: Make search feel responsive and reliable for topics, then extend to seforim.

### Phase 2a: Topics Search Feel (IMMEDIATE)
- [x] Audit `/api/search` topics filter: decide whether to fetch broader set + rely on Fuse, or expand server-side filter to include `slug` + future translation fields.
- [x] Test: typing a topic's English name reliably returns that topic (no vanishing as you add letters).
- [x] Update `CommandMenu` to show topic results with clear category/type badge.

### Phase 2b: Seforim Search (After 2a)
- [x] Finalize where seforim live: `documents` (current) or dedicated `seforim` collection. **DONE**
- [x] Ensure `/api/search` queries the right collection and handles permissions gracefully. **DONE**
- [x] Test: searching "Tanya" or other sefer titles returns results in Sources section. **DONE**

### Phase 2c: Mobile Search UX (After 2b)
- [x] Convert `CommandMenu` on small screens to a true **bottom sheet** (full-height, swipe-down to close). **DONE**
- [x] Add larger touch targets and clearer result type differentiation. **DONE**
- [x] Test on real mobile device: open, search, select, close all feel smooth. **DONE**

---

## TRACK 3: TorahReader (Tanya â†’ Generic)

**Goal**: Generalize the Tanya prototype into a reusable reader for any sefer.

### Phase 3a: Extract & Generalize (IMMEDIATE)
- [x] Created advanced TorahReader in `/seforim/[seferId]/page.tsx` with virtual scrolling, citation handling, settings, and mobile optimization
- [x] Generalized TorahReader component (`/components/TorahReader.tsx`) for flexible content structures
- [x] Integrated Directus data fetching for all sefer content
- [x] Tested `/seforim/[seferId]` routes work for any document type
- [x] Created comprehensive documentation (`TORAH_READER_DOCUMENTATION.md`) with usage examples, API integration, and future extensibility

### Phase 3b: Directus Modeling (After 3a)
- [x] Model `documents` (seforim) â†’ `paragraphs` (chapters/sections) â†’ `statements` (lines/blocks) in Directus. **DONE**
- [ ] Add `translations` collection entries for Hebrew/English pairs.
- [x] Wire `[perek]/page.tsx` to fetch from Directus instead of local file. **DONE** (Dec 8, 2025)

### Phase 3c: Generic Reader Integration (COMPLETED - Dec 25, 2025)
- [x] Integrated `TorahReader` into `app/seforim/[seferId]/page.tsx`.
- [x] Maps Directus `contentBlocks` and `statements` to reader sections.
- [x] Supports English toggle, inline commentaries, and reading settings (Sepia/Charcoal themes).

---

## TRACK 5: Content Editor (Lower priority, after core tracks)

**Goal**: Build a WYSIWYG editor for content creators to easily edit topics and books, aligned with the current Directus model. Behind authentication with Editor role.

### Phase 5a: MVP Editor Forms (After Phase 1b)
- [x] Create `/editor/topics/[slug]` page for editing topic definitions
- [x] Form fields for: canonical_title, description, topic_type, definition_positive, definition_negative
- [x] Save to Directus via API with authentication
- [x] Basic validation and error handling
- [x] Redirect to topic page after save
- [x] Create `/editor/topics` page for topic management with search and filtering

### Phase 5b: Rich Text & Order Management (After Phase 5a)
- [ ] Add rich-text WYSIWYG for `description` and metadata fields (Markdown/HTML support).
- [ ] Build Paragraphs editor with order-key generation (auto-increment LexoRank).
- [ ] Build Statements editor with inline topic tagging interface.
- [ ] Add bulk import/export for JSON files (aligned with DATA_INGESTION_SPEC_v2).
- [ ] Test: Editors can structure a full sefer hierarchy and tag statements.

### Phase 5c: Translation & Review UI (After Phase 5b)
- [ ] Add side-by-side translation interface for statements/paragraphs.
- [ ] Build review workflow for translation quality levels.
- [ ] Add preview mode to see how content renders in frontend.
- [ ] Test: Translators can work efficiently and preview changes.

---

## TRACK 6: Editor Refactor (Phase 2 - COMPLETED)

**Goal**: Clean up the codebase now that citation feature is working.

### Phase 2.1: Extract Citation Plugin (COMPLETED)
- [x] Move citation logic from `ProseEditor.tsx` into a self-contained ProseMirror plugin in `components/editor/plugins/citations/`
- [x] Include: cmdk palette, suggestion trigger, node insertion logic
- [x] Update ProseEditor to use the new comprehensive citation plugin
- [x] Test: Citation workflow still works after extraction

### Phase 2.2: Extract `useEditor` Hook (COMPLETED)
- [x] Review current `useEditor` hook implementation
- [x] Consolidate any remaining data-fetching, state management, and save logic from `app/editor/page.tsx`
- [x] Ensure page component is clean and isolated editor logic

---

## ðŸš¨ CRITICAL INFRASTRUCTURE ISSUES (URGENT - BLOCKING EDITOR)

### **Directus Permissions Configuration (REQUIRED)**
**Status:** âŒ NOT DONE - BLOCKING EDITOR FUNCTIONALITY
**Impact:** Editor completely broken - 403 Forbidden on all API calls
**Action Required:**
- Login to Directus Admin: https://directus-production-20db.up.railway.app/admin
- Go to Settings â†’ Access Control
- Create/configure "Public" role with READ permissions for:
  - documents collection (all fields)
  - topics collection (all fields) 
  - sources collection (all fields)
  - authors collection (all fields)
- Assign static token `Y2uEb9-2oyj8-DEn5eeJypUw7xUGuR96` to Public role
- Test: Editor should load StructureSidebar and citations without 403 errors

**Next Agent:** Check if this has been resolved before proceeding with any editor work!

---

## TRACK 10: Critical Bug Fixes (COMPLETED - Dec 25, 2025)

**Goal**: Fix critical bugs preventing core functionality from working. **ALL RESOLVED**

### Phase 10a: Seforim Page Recovery (DONE)
- [x] **Diagnose Directus client initialization** - Fixed URL construction in `lib/directus.ts`
- [x] Fix: Used absolute URL for client-side Directus calls.
- [x] Test: `/seforim` loads without error.
- [x] Test: All `/seforim/[seferId]` routes render correctly using `TorahReader`.

### Phase 10b: Search Modal Navigation Fix (DONE)
- [x] **Fix undefined document ID** - Added `.filter(s => s.id)` in mapping.
- [x] Test: Search results navigate to valid pages.
- [x] Test: No `/seforim/undefined` URLs generated.

### Phase 10c: Search Modal Close Button (DONE)
- [x] **Fix mobile close intent** - Added dedicated "Cancel" button to mobile UI.
- [x] Test: Clicking "Cancel" closes modal; `X` clears text.
- [x] Test: Escape key closes modal.

---

## TRACK 11: Seforim Reader Vision (Future - Brainstorming)

**Goal**: Create the best Seforim reader ever. See comprehensive vision docs.

### Key Vision Documents
- **[CHABAD-MAFTEIACH-ROADMAP.md](file:///Users/yitzchok/Documents/Directus/chabad-research/CHABAD-MAFTEIACH-ROADMAP.md)** - 8-phase evolution roadmap
- **[Use cases and persona.MD](file:///Users/yitzchok/Documents/Directus/chabad-research/Documentation/Use%20cases%20and%20persona.MD)** - UX architecture, user flows, device patterns
- **[Seforim-Images-Plan.md](file:///Users/yitzchok/Documents/Directus/chabad-research/Documentation/Seforim-Images-Plan.md)** - Cover images implementation

### Core Principles (from User Research)
1. **Flow-State Preservation** - Never break learning momentum (target: <10 seconds for 90% of lookups)
2. **Boundaries System** - Every concept needs "what it IS" + "what it's NOT"
3. **Progressive Depth** - Level 1 (instant glance) â†’ Level 4 (scholarly deep dive)
4. **Device-Aware UX** - Mobile: voice search, offline, sharing; Desktop: multi-tab, shortcuts

### 8-Phase Roadmap Summary
1. Enhanced Reading (typography, themes, bookmarks)
2. Advanced Citations (inter-text linking, networks)
3. Social & Collaborative (annotations, reading groups)
4. AI Analysis (semantic search, concept mapping)
5. Multi-Platform (PWA, mobile apps, offline)
6. Advanced Study (split screen, timeline, network views)
7. Multilingual (Hebrew-English parallel, translation overlays)
8. AI/ML Integration (personalized learning, pattern recognition)

---

## TRACK 12: Scraping & Data Population (The Ingestion Engine)

**Goal**: Automate the ingestion of Chabad Library texts into proper Directus structures.

### Phase 12a: Scraper Refinement
- [ ] Stabilize depth-first traversal for hierarchical books.
- [ ] Implement rate-limit aware sequential processing.
- [ ] Test on large books (e.g. Likkutei Torah).

### Phase 12b: Granular Statement Parsing
- [ ] Implement `parseFootnotesIntoStatements` logic to separate citations from main text.
- [ ] Wire Hebrew folio number conversion (×, × â†’ 1a).
- [ ] Auto-detect language (Hebrew/English) per statement.

### Phase 12c: Bulk Population
- [ ] Create `populate_chabad_book.js` CLI tool for ease of use.
- [ ] Batch insert records to Directus to minimize API overhead.

---

## TRACK 13: Advanced Citation Mapping & Resolution

**Goal**: Turn static citations into a living web of inter-textual links.

### Phase 13a: Citation Extraction
- [ ] Extract structured citation metadata from footnotes.
- [ ] Assign confidence scores based on pattern matching (Book/Folio/Section).
- [ ] Store metadata in `statement.metadata.citation_references`.

### Phase 13b: Deferred Link Resolution
- [ ] Create background job to match extracted citations against newly added books.
- [ ] Update `resolved_link` fields when targets become available.
- [ ] Implement fuzzy matching for book title variations.

### Phase 13c: Interactive Navigation
- [ ] Wire frontend tooltips to show resolved links.
- [ ] Implement "Jump to Source" functionality in the reader.

---

## TRACK 14: Flexible Content Ingestion & AI Smart Detection

**Goal**: Support diverse content types (Bio, Topics, Articles) with intelligent routing.

### Phase 14a: Flexible Mapping
- [ ] Implement multi-type ingestion (Article, Bio, Topic Description, Reference, Metadata).
- [ ] Build validation rules per content type to prevent schema violations.
- [ ] Map frontmatter fields dynamically to Directus collections.

### Phase 14b: Smart detection
- [ ] Use LLM or pattern matching to auto-detect content type during upload.
- [ ] Implement pre-upload validation and "dry-run" mapping preview.

### Phase 14c: Ingestion Analytics
- [ ] Track import history and success rates per user.
- [ ] Build dashboard for ingestion status and error resolution.

---


## TRACK 4: Infrastructure & Testing (Lower priority, do in parallel)

- [x] Decide final Directus public-access model: which collections/fields readable by static token. **DONE** (JWT auth implemented)
- [ ] Implement + test permission changes in staging before production.
- [x] Add integration tests for topics, search, and TorahReader to catch regressions. **FOUNDATION COMPLETE** (Jest setup ready, complex tests deferred)
- [x] Document the new topics data model and frontend mapping in repo docs. **DONE** (See `lib/types/index.ts` and `Documentation/New-directus-data-model.md`)
- [ ] Re-enable term-linking pipeline (`linkTerms`) once topics schema is stable (Phase 1c).
- [x] Align TypeScript types with new Directus schema. **DONE** (Dec 8, 2025)
- [x] Set up Jest testing framework with performance monitoring. **DONE** (Bundle: 1.12 MB JS, 1.45 MB total)

---

## Component Cleanup Tasks (Added Dec 8, 2025)

**Priority**: High - Remove unused code to improve maintainability

1. **[HIGH] Remove 3 unused components** - Immediate cleanup to reduce bundle size:
   - `button` (UI component) - **REMOVED**
   - `TanyaChapterReader` - **REMOVED** 
   - `TopicOverview` - **REMOVED**

2. **[HIGH] Complete TopicTabs implementation** - Currently only renders OverviewTab, needs full tab functionality

3. **[MEDIUM] Reconfigure topic components for new DB schema** - Future implementation:
   - `TopicArticle` - Connect to Document + paragraph/statement system
   - `RelatedTab` - Link to existing related topics in DB
   - `SourcesTab` - Reconfigure for new Directus schema
   - `TopicSidebar` - Shelve for future use

4. **[MEDIUM] Review and split large components** - Consider breaking down:
   - `BookReader` (346 lines) - consider lazy loading
   - `CommandMenu` (302 lines) - extract business logic
   - `SourcesTab` (231 lines) - if re-used
   - `OverviewTab` (208 lines) - if re-used

5. **[MEDIUM] Add component documentation** - Document complex features and interfaces

6. **[LOW] Extract business logic from UI components** - Separate concerns where appropriate

7. **[LOW] Implement lazy loading for large components** - Optimize bundle size and loading performance

---

## Remaining Roadmap Items from Editor Audit:
- Implement full Phase 2 refactor, including consolidating all editor state management into hooks and extracting plugins.
- Add contextual editing for citations, such as making citation chips clickable for quick edits.
- Develop collaboration features using Operational Transformation (OT) or CRDTs for real-time editing.
- Enhance author disambiguation UI for better user prompts and error handling.

---

## Execution Order (Recommended)

1. **Start with TRACK 1, Phase 1a** (Topics MVP): unblocks everything else, takes ~1â€“2 days.
2. **Then Component Cleanup Task #1** (Remove unused components): immediate code quality improvement, ~0.5 day.
3. **Then TRACK 2, Phase 2a** (Topics search): makes the app feel responsive, ~1 day.
4. **Then Component Cleanup Task #2** (Complete TopicTabs): unblock topic functionality, ~0.5 day.
5. **Then TRACK 3, Phase 3a** (TorahReader extraction): sets up for real Directus data, ~1 day.
6. **Then TRACK 1, Phase 1b** (Rich content fields): expands topics, ~2â€“3 days.
7. **Parallel**: Remaining component cleanup tasks (#3-6) and TRACK 4 (infrastructure) as needed.

---

## Notes for the Team

- **Each phase is a complete, shippable unit.** Don't move to the next phase until the current one is tested and working.
- **Directus schema changes** (adding fields, permissions) should be done in staging first, tested, then promoted to production.
- **Mobile testing is critical** for Phases 1a, 2c, 3a. Use real devices or DevTools emulation.
- **Ask questions early** if a phase's scope is unclear or blocked by missing Directus data.

---

## TRACK 7: Security & Reliability (Added from Security Audit)

**Goal**: Secure the application against unauthorized access and ensure stability under load.

### Phase 7a: Authentication & Authorization (High Priority)
- [x] **Implement Auth Layer**: Integrate NextAuth.js or Directus Auth for API routes.
- [x] **Secure API Routes**: Protect /api/ingest/* and /api/statements/break against unauthenticated access.
- [x] **Token Management**: Ensure no write-access tokens are ever exposed to the client (process check).

---

## TRACK 8: Innovation & Features (Future Vision)

**Goal**: Transform the platform into a dynamic, collaborative scholar tool.

### Phase 8a: Advanced Editor Features
- [ ] **Collaborative Editing**: Real-time multi-user editing using ProseMirror + WebSockets.
- [ ] **AI Citation Verification**: Verify detected citations against external APIs (Sefaria, HebrewBooks).

### Phase 8b: Visualization & Discovery
- [ ] **Interactive Graph**: Visualize topic connections using react-force-graph-2d.
- [ ] **Source-First View**: Browse entire works (e.g. Tanya) with overlay annotations.
- [ ] **Personalized Learning**: Recommendation engine based on user reading history.

---

## TRACK 9: UX Audit & Fixes (Immediate Priority)

**Goal**: Fix critical user experience issues identified in comprehensive audit.

### Phase 9a: Critical Flow Blockers
- [x] **Fix Article tab dead end** - Implemented `OverviewTab` for summary content (Dec 25, 2025).
- [x] **Fix data integrity issues** - Resolve statement_topics table orphans causing empty article tabs (BLOCKING articles)
- [x] **Implement citation modal viewer** - Complete citation click handling with modal showing source details (BROKEN user interaction)

### Phase 9b: Navigation & Discovery Issues  
- [x] **Audit navigation links** - Ensure all header navigation links are functional (/topics, /seforim, /explore, /collections)
- [x] **Improve search reliability** - Fix vanishing results, ensure topics/authors/sources discoverable
- [x] **Add user onboarding flow** - Guide new users from home page to first meaningful interaction

### Phase 9c: Visual & Mobile Polish
- [x] **Fix dark mode styling** - Align book text page gradients/colors with main UI theme in dark mode
- [x] **Replace Collections placeholder** - Implement functional bookmarks/saved items system
- [x] **Audit mobile UX** - Test bottom sheets, touch targets, swipe gestures, navigation flow

### Phase 9d: System Reliability
- [ ] **Audit editor permissions** - Resolve 403 errors, ensure proper Directus role configuration for editor functionality

### Phase 9e: Quick Wins (< 2 hours each)
- [x] **Improve Article empty state** - Replace "Coming Soon" dead end with topic description and helpful next steps
- [x] **Basic Collections functionality** - Implement localStorage bookmarking for topics with simple UI
- [x] **Home page onboarding hints** - Add subtle guidance for first-time users
- [ ] **Navigation link testing** - Verify all header links work, fix any 404s
- [x] **Mobile search UX** - Test and fix bottom sheet behavior, touch targets. **DONE**

---

## ðŸš¨ ARCHITECTURAL CONCERNS (REQUIRES DISCUSSION)

### Data Integrity & Statement Synchronization
**Issue**: What happens if text in paragraph changes, will it throw the statement system out of sync?
- **Impact**: Could break citations, references, and user bookmarks
- **Solution Needed**: Version control system for paragraphs/statements
- **Discussion Required**: How to handle text updates without breaking existing references

### Statement-to-Topic Linking Architecture
**Issue**: New version of statements to pull concepts into topics as sources. How to quote multi-page concepts?
- **Impact**: Current statement_topics table only links single statements to topics
- **Solution Needed**: Support for statement ranges, page ranges, or concept spans
- **Discussion Required**: Schema changes for multi-statement topic associations

---

